name: Terraform CI/CD For Deploying Yandex Cloud Services
run-name: ${{ github.actor }} triggered the pipeline

on:
  pull_request:
    branches:
      - "main"
  push:
    branches:
      - "main"
env:
  YC_SERVICE_ACCOUNT_KEY_FILE: ${{ secrets.YC_SERVICE_ACCOUNT_KEY_FILE }}
  ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  TF_VAR_ssh_key: ${{ secrets.TF_VAR_SSH_KEY }}

jobs:
  build-infra:
    name: terraform-ci-cd
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Terraform Init
        id: init
        run: terraform init -backend-config="access_key=$ACCESS_KEY" -backend-config="secret_key=$SECRET_KEY"
        working-directory: ./
      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ./
      - name: Terraform Apply
        id: apply
        run: terraform apply --auto-approve
        working-directory: ./
#      - name: Terraform Destroy
#        id: destroy
#        run: terraform destroy --auto-approve
#        working-directory: ./